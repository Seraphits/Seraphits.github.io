"use strict";(self.wpRiseJsonp=self.wpRiseJsonp||[]).push([["profiler"],{19540:(fe,w,d)=>{d.r(w),d.d(w,{DEFAULT_RUM_PROFILER_CONFIGURATION:()=>L,createRumProfiler:()=>Y});var I=d(33564),f=d(20806),V=d(34724),k=d(67656),j=d(27616),P=d(62679),T=d(96036);function C(e){let n=0;for(const a of e)a.stackId!==void 0&&n++;return n}const v=new Map;function me(){v.clear()}function B(e,n){v.set(n,e)}function G(e){return v.get(e)}function E(e){for(const n of v.keys())n<e&&v.delete(n)}function H({rawRumEvent:e,startTime:n}){if(e.type!==T.bb.LONG_TASK)return;const a=e.long_task.id;B(a,n)}const J=/\/(?![vV]\d{1,2}\/)([^/\d?]*\d+[^/?]*)/g;function x(e){return e?e.replace(J,"/?"):"/"}const S=(e,n)=>e||x(n);var z=d(35574);function K(e,n,a){const i={application:{id:n}};a&&(i.session={id:a});const{ids:m,names:l}=X(e.views);m.length&&(i.view={id:m,name:l});const g=e.longTasks.map(h=>h.id).filter(h=>h!==void 0);return g.length&&(i.long_task={id:g}),i}function X(e){const n={ids:[],names:[]};for(const a of e)n.ids.push(a.viewId),a.viewName&&n.names.push(a.viewName);return n.names=Array.from(new Set(n.names)),n}function Z(e,n,a){return{event:Q(e,n,a),"wall-time.json":e}}function Q(e,n,a){const i=(0,z.m5)(n),m=K(e,n.applicationId,a),l=W(i);return{...m,attachments:["wall-time.json"],start:new Date(e.startClocks.timeStamp).toISOString(),end:new Date(e.endClocks.timeStamp).toISOString(),family:"chrome",runtime:"chrome",format:"json",version:4,tags_profiler:l.join(","),_dd:{clock_drift:(0,f.TP)()}}}function W(e){return e.concat(["language:javascript","runtime:chrome","family:chrome","host:browser"])}const L={sampleIntervalMs:10,collectIntervalMs:6e4,minProfileDurationMs:5e3,minNumberOfSamples:50};function Y(e,n,a,i,m,l=L){const g=(0,T.wP)(e,n,m,6),h=(0,T.s5)(T.do.LONG_ANIMATION_FRAME);let y;const M=[];let o={state:"stopped"};function $(t){o.state!=="running"&&(y=t?{startClocks:t.startClocks,viewId:t.id,viewName:S(t.name,document.location.pathname)}:void 0,M.push((0,I.q)(e,window,"visibilitychange",ne).stop,(0,I.q)(e,window,"beforeunload",se).stop),b())}async function q(){await N("stopped"),M.forEach(t=>t()),E((0,f.M8)().relative),i.set({status:"stopped",error_reason:void 0})}function _(t){if(t.state==="running")return{cleanupTasks:t.cleanupTasks,observer:t.observer};const s=[];let r;if(e.trackLongTasks){r=new PerformanceObserver(te),r.observe({entryTypes:[oe()]});const u=n.subscribe(12,p=>{H(p)});s.push(()=>r?.disconnect()),s.push(u.unsubscribe)}const c=n.subscribe(2,u=>{const p={viewId:u.id,viewName:S(u.name,document.location.pathname),startClocks:u.startClocks};R(p),y=p});return s.push(c.unsubscribe),{cleanupTasks:s,observer:r}}function b(){const t=(0,V.VZ)().Profiler;if(!t)throw i.set({status:"error",error_reason:"not-supported-by-browser"}),new Error("RUM Profiler is not supported in this browser.");O(o).catch(k.Dx);const{cleanupTasks:s,observer:r}=_(o);let c;try{c=new t({sampleInterval:l.sampleIntervalMs,maxBufferSize:Math.round(l.collectIntervalMs*1.5/l.sampleIntervalMs)})}catch(u){u instanceof Error&&u.message.includes("disabled by Document Policy")?(j.Vy.warn("[DD_RUM] Profiler startup failed. Ensure your server includes the `Document-Policy: js-profiling` response header when serving HTML pages.",u),i.set({status:"error",error_reason:"missing-document-policy-header"})):i.set({status:"error",error_reason:"unexpected-exception"});return}i.set({status:"running",error_reason:void 0}),o={state:"running",startClocks:(0,f.M8)(),profiler:c,timeoutId:(0,P.wg)(b,l.collectIntervalMs),longTasks:[],views:[],cleanupTasks:s,observer:r},R(y),c.addEventListener("samplebufferfull",D)}async function O(t){var s,r;if(t.state!=="running")return;A((r=(s=t.observer)===null||s===void 0?void 0:s.takeRecords())!==null&&r!==void 0?r:[]),(0,P.DJ)(t.timeoutId),t.profiler.removeEventListener("samplebufferfull",D);const{startClocks:c,longTasks:u,views:p}=t,le=(0,f.M8)();await t.profiler.stop().then(F=>{const U=(0,f.M8)(),ce=u.length>0,ue=(0,f.vk)(c.timeStamp,U.timeStamp)<l.minProfileDurationMs,de=C(F.samples)<l.minNumberOfSamples;!ce&&(ue||de)||(ee(Object.assign(F,{startClocks:c,endClocks:U,clocksOrigin:(0,f.Oc)(),longTasks:u,views:p,sampleInterval:l.sampleIntervalMs})),E(le.relative))}).catch(k.Dx)}async function N(t){o.state==="running"&&(o.cleanupTasks.forEach(s=>s()),await O(o),o={state:t})}function R(t){o.state!=="running"||!t||o.views.push(t)}function ee(t){var s;const r=(s=a.findTrackedSession())===null||s===void 0?void 0:s.id,c=Z(t,e,r);g.send(c)}function D(){b()}function te(t){A(t.getEntries())}function A(t){if(o.state==="running")for(const s of t){if(s.duration<l.sampleIntervalMs)continue;const r=(0,f.FR)(s.startTime),c=G(r.relative);o.longTasks.push({id:c,duration:s.duration,entryType:s.entryType,startClocks:r})}}function ne(){document.visibilityState==="hidden"&&o.state==="running"?N("paused").catch(k.Dx):document.visibilityState==="visible"&&o.state==="paused"&&b()}function se(){b()}function oe(){return h?"long-animation-frame":"longtask"}function re(){return o.state==="stopped"}function ae(){return o.state==="running"}function ie(){return o.state==="paused"}return{start:$,stop:q,isStopped:re,isRunning:ae,isPaused:ie}}}}]);
